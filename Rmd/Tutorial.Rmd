---
title: 'So Many Species, So Little Time: Measuring Biodiversity'
author: "Margaret Slein, Jory Griffiths, Egor Katkov (Living Data Project)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = T, warning=F, message=F, echo=F)
knitr::opts_knit$set(root.dir = "..")
```



Ecologists are often interested in the effects of perturbations (e.g. fires, logging, flooding or pollution) on biodiversity. 
However, boiling biodiversity down to a single metric can be difficult.
With the help of the Turkey lake dataset of benthic invertebrates [@reference], we will present you with a number of common metrics, their meaning, and how they can be visualized with the help of a Rank-Abundance curves. 
You will then have the option to learn to do it yourself using an R package called codyn.

# The Data

The Turkey Lakes Watershed Study (see map) is an initiative by several agencies of the government of Canada, initially designed to study the effects of acid rain on forest ecosystems.
From 1995 to 2009, scientists collected, identified and counted benthic invertebrates from various stream beds around the Turkey Lakes catchment. 
Benthic invertebrates are small, often microscopic organisms (see Fig. 1), but form an important link between aquatic and terrestrial habitats . 
They can decompose terrestrial matter such as leaves, or consume periphyton growing on rocks within their streams.
Benthic invertebrates can be a food source for aquatic animals, like small fish, or terrestrial animals such as fish.
An experiment was conducted in 1997, where certain sampling sites experienced different levels of logging intensity.
Due to their interaction with the terrestrial realm, we can hypothesize that the biodiversity of benthic invertebrate communities might be affected by logging.

![Fig. 1: Various benthic macroinvertebrates under a stereo microscope. Source: G. Carter via NOAA/GLERL](benthicmacroinvertebrates_g.carter_noaa600px.jpg)



```{r include=T}
pacman::p_load(leaflet)

leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-84.4110, lat=47.0515, popup="Turkey Lakes")

```

# Why biodiversity matters 

In an ever-changing world, as biologists, we are often concerned with how organisms will be able to cope with disturbances and increasingly, global climate change. We often think of biodiversity as an important buffer to withstanding these changes, as more diversity may mean more success in environments persisting beyond the change. It is the idea of survival of the fittest, but with more security in sheer numbers. 


# Types of data typically collected

Often times, biologists interested in collecting biodiversity data collect a standard set of responses. These often include:

1. The different kinds of species in a given area or environment 
2. The number of each of these species (abundance)
3. Information about the area itself (i.e. habitat type, weather conditions, etc.)
4. If the work involves an setting up an experiment, collecting the control vs. experimental groups as well as metrics for repeatability + statistical power (replicates)
5. Of course, the time frame over which the data were collected

# Different way to analyse this data :

Once we have collected our biodiversity data, there are several different ways to analyse and understand changes in community composition:


## Quantifying Species Richness
                                 
Perhaps the simplest measure of biodiversity is species richness ($S$). 

$S = \sum_{i=1}^{S}p_i^o$

We can calculate species richness by simply counting the number of each in an area. 
```{r}
pacman::p_load(tidyverse, patchwork)
set.seed(222)
sim1 <- data.frame(
  species = sample(1:10, 20, replace=2), 
  abundance = sample(0:200, 20, replace=2), 
  time= 2001)
set.seed(723)
sim2 <- data.frame(
  species = sample(1:10, 20, replace=2), 
  abundance = sample(0:200, 20, replace=2), 
  time= 2009)
set.seed(117)
sim3 <- data.frame(
  species = sample(1:7, 20, replace=2), 
  abundance = sample(0:200, 20, replace=2), 
  time= 2020)
sim <- rbind(sim1, sim2, sim3)
```

Using simulated data, we can think about the number of different species in a community may change over time. 

```{r}
pacman::p_load(codyn, kableExtra)
#table just showing the number of unique species
#species richness calcs i used to manually enter below
richness_table <- sim %>%
  group_by(time) %>%
  summarise(richness=length(unique(species)))
#we should probably make this into a nice looking kable?
kable(richness_table)
```

We can see in this table that across years, the number of species in the same area fluctuated, some years with more species, other years with less. 


```{r}
calc <- sim %>%
  group_by(time, species) %>%
  summarise(n=n()) %>%
  mutate(richness= case_when(time %in% c("2001", "2009") ~ 9, 
                             TRUE~ 7), 
    prop = n/sum(n),
    shannon= sum(prop/log(prop)), 
    evenness = shannon/log(richness),
    simpson = sum((prop)^2)) %>%
  as.data.frame()
```

## Shannon-Wiener Index (H)

Another metric we can use to analyse biodiversity is the Shannon-Wiener Index ($H$), which indexes across the sum of all relative proportions of species richness's with an additional logarithmic transformation. This equation uses both the number of species in a specific area (richness) and relative abundance (evenness). 

$H' = - \sum_{i=1}^{S}p_ilnp_i$

```{r}
shannon<- calc %>%
  group_by(time) %>%
  summarise(mean(shannon))
kable(shannon)
```

From our simulated dataset, we can see that the Shannon diversity decreases over time, which suggests that we lost important species as time went on. 


## Simpson's Index (D)

Another metric we can use to analyse biodiversity in the Simpson's index ($D$) which indexes across the sum of all relative proportions of species's richness with an additional square power transformation. This equation. Though very similar to the calculation in the Shannon-Wiener Index, the Simpson index is more focused on dominance of species as it highlights the proportion of species in a sample.


$\gamma = - \sum_{i=1}^{S}p_i^2$

```{r}
simpson<-calc %>%
  group_by(time) %>%
  summarise(mean(simpson))
kable(simpson)
```
Interestingly, the Simpson index appears to increase ovee time -- which suggests biodiversity is increasing?

<> This definitely needs more interpretation

## Evenness Index (E)

Additionally, we can think about the evenness of species across a given area. Evenness is a metric for assessing species dominance, if evenness is high, it means most species are of equal dominance. If evenness if low, it means some species are more dominance than others

$E = H / ln(S)$

```{r}
evenness <- calc %>%
  group_by(time) %>%
  summarise(mean(evenness))
kable(evenness)
```

In our simulated dataset, we can see that evenness is low from the start and decreases over time, suggesting that more species become increasingly dominant over time. 

## Community Stability

<> I am missing information on this calculation 

# Ways we can convey all of this information in graphs 

## Rank Abundance Curve

One way to visualize biodiversity data is to make a Rank Abundance Curve (RAC). On the y-axis we have the abundance of each species, and species, ranked by abundance on the x-axis. Using RACs, we can visualize relative abundances, changes in species dominance, and overall changes in community composition with species loss and gain. 


```{r}
library(tidyverse)
# Code or exercise on calculating species richness?
#before 
pacman::p_load(tidyverse, patchwork)
set.seed(2)
data_2007 <- data.frame(
  species = sample(1:10, 20, replace=2), 
  abundance = sample(0:200, 20, replace=2), 
  time= 2007)

data_2018 <- data.frame(
  species = sample(1:10, 20, replace=2), 
  abundance = sample(0:200, 20, replace=2), 
  time= 2018) 

data <- rbind(data_2007, data_2018) %>%
  group_by(species, time) %>%
  summarise(abundance= sum(abundance))


#2007
a<- data %>%
  filter(time == 2007 ) %>%
ggplot( aes(x=reorder(species, -abundance), y=abundance))+
  geom_point(size=4, colour="purple")+
  ggtitle("2007")

#2007
b<- data %>%
  filter(time == 2018 ) %>%
ggplot( aes(x=reorder(species, -abundance), y=abundance))+
  geom_point(size=4, colour="blue")+
  ggtitle("2018")


a / b
```

We can see here between 2007 and 2018 in our simulated community, there were differences in absolute abundance as well as which species were dominant, which species disappeared, and which species were new. For instance, in 2007, species 2 was the third most abundant species, but it 2018, it was the most abundant species. However, species 3 is lost by 2018, while species 10 is gained in 2018. 


In contrast, RACs in nature are rarely as evenly distributed as the simulated data. 
Indeed, there is often one or two highly abundant and a large number of very rare species. 

```{r}
source("R/RankAbundance/plotRankAbundance.R")

plotRankAbundance(log=F,
                  select_catchment = "34L",     
                  select_year      = c(1998,1998),     
                  select_month     = c("june"))
```

To better visualize the distribution, the y-axis is typically log-transformed

```{r}
plotRankAbundance(log=T,
                  select_catchment = "34L",     
                  select_year      = c(1998,1998),     
                  select_month     = c("june"))
```

Because most classic metrics of biodiversity do not take the species identity into account, we can drop species names from the x-axis, and simply refer to it's rank in the community. This is where the term **rank**-abundance comes from. 


```{r}
plotRankAbundance(log=T,
                  select_catchment = "34L",     
                  select_year      = c(1998,1998),     
                  select_month     = c("june"), 
                  SpName           = F)
```

Finally, instead of using bars to represent abundances, we can simply use a lines to trace the distribution. This allows us to compare multiple distributions.

```{r}
source("R/RankAbundance/plotRAC.R")
sumOverReplicates() %>% 
  filter(year=="2001") %>%
  plotRAC(facets = F)
```

TODO: Show how biodiversity metrices (sp. richness, eveness) relate to the plot
TODO: Fit a model line to the plots? e.g. broken stick etc.

### NOTES 
I got the equations from this paper: DOI:10.1007/s10531-016-1261-0
All parameters/variables in the equations need to be defined! -Egor
